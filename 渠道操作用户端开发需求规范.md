# 渠道操作用户端开发需求规范

## 🎯 项目概述
开发一款基于Python的猫池短信发送客户端，供渠道操作用户使用。

## 🔐 1. 用户认证模块

### 1.1 登录验证
- **用户类型**: 渠道操作用户（channel_operators表）
- **验证方式**: 用户名 + 密码 + MAC地址绑定
- **MAC验证**: 检查当前机器MAC地址是否已授权
- **失败处理**: MAC未授权或密码错误时禁止登录

### 1.2 数据库验证流程
```sql
-- 1. 验证用户名密码
SELECT * FROM channel_operators WHERE operators_username = ? AND operators_status = 'active'
-- 2. 验证MAC地址
WHERE operators_mac_address = ? OR operators_mac_address IS NULL
-- 3. 获取积分信息
SELECT operators_available_credits FROM channel_operators WHERE operators_id = ?
```

## 🖥️ 2. 界面布局设计

### 2.1 顶部状态栏
- **软件名称**: "猫池短信系统"
- **用户信息**: 显示登录用户名
- **积分显示**: "余额: 积分XXXXX" （五分钟更新一次）

### 2.2 左侧任务区域
#### 2.2.1 任务控制按钮
- **停止发送**: 停止所有正在运行的任务
- **添加任务**: 打开创建任务对话框
- **更多操作**: 下拉菜单包含
  - 清除已完成任务
  - 清除所有任务

#### 2.2.2 创建任务对话框字段
- **任务名称**: 文本输入框（必填）
- **目标号码**: 文本域或文件上传（必填）
- **短信模板**: 下拉选择框（可选）
- **号码模式**: 单选框（国内号码/国际号码）
- **主题**: 文本输入框（彩信用）
- **短信内容**: 文本域（必填）

#### 2.2.3 任务列表显示
| 字段名 | 说明 | 数据来源 |
|--------|------|----------|
| 任务名称 | tasks_title | tasks表 |
| 进度 | "已发送/总数" | tasks_success_count + tasks_failed_count / tasks_total_count |
| 成功 | 成功数量 | tasks_success_count |
| 失败 | 失败数量 | tasks_failed_count |
| 状态 | 任务状态 | tasks_status |

#### 2.2.4 任务操作按钮
- **开始任务**: 启动任务执行（tasks_status: draft/pending → running）
- **暂停任务**: 暂停任务执行（tasks_status: running → paused）
- **重试失败**: 重新发送失败的消息
- **测试任务**: 弹出测试对话框
- **修改内容**: 编辑任务信息
- **导出已完成**: 导出成功发送的消息明细
- **导出未完成**: 导出失败/待发送的消息明细
- **删除任务**: 软删除任务（不显示在界面）

#### 2.2.5 测试任务对话框
- **测试手机号**: 输入框（验证手机号格式）
- **测试端口**: 下拉选择可用端口
- **确定按钮**: 发送测试短信并显示结果

### 2.3 右侧端口管理区域
#### 2.3.1 端口控制按钮
- **全选**: 选中所有端口
- **取消全选**: 取消所有端口选择
- **反选**: 反向选择端口
- **选项**: 打开配置对话框
- **启动端口**: 启动选中的端口
- **停止端口**: 停止选中的端口
- **清除全部记录**: 清空所有端口的发送统计
- **清除当前记录**: 清空选中端口的发送统计

#### 2.3.2 选项配置对话框
```
选项配置:
*发送间隔: [1000] 毫秒
*卡片更换: [60] 条/次

监测设置:
*发送成功: [1000] 条
监测号码: [手机号码输入框]
```

#### 2.3.3 端口显示格式
显示为网格布局，每个端口显示：
- **端口名称**: COM1, COM2等
- **运营商**: 中国移动/联通/电信
- **上限**: 发送上限设置
- **成功**: 成功发送数量
- **状态**: 可用/忙碌/错误/离线

## ⚙️ 3. 核心业务逻辑

### 3.1 任务执行流程
1. **任务创建**: 插入tasks表，状态为draft
2. **号码解析**: 解析目标号码，插入task_message_details表
3. **任务启动**: 更新状态为running，开始发送
4. **消息分发**: 将消息分配给可用端口
5. **发送执行**: 通过串口发送短信
6. **状态更新**: 更新消息状态和任务进度
7. **积分扣除**: 每成功发送一条扣除对应积分

### 3.2 端口管理逻辑
- **端口扫描**: 自动检测可用COM端口
- **状态监控**: 实时监控端口连接状态
- **负载均衡**: 智能分配消息到空闲端口
- **错误处理**: 端口错误时自动切换

### 3.3 发送控制规则
- **发送间隔**: 每个端口发送间隔JG毫秒（默认1000ms）
- **卡片更换**: 每发送GH条后暂停，需手动清除记录继续
- **监测提醒**: 发送TX条后需要重复发送一条同样内容到检测号码

### 3.4 积分管理
- **积分查询**: 实时显示当前可用积分
- **积分扣除**: 发送成功时扣除积分（短信1分，彩信3分）
- **余额不足**: 积分不足时禁止发送

## 📊 4. 数据库交互

### 4.1 主要表结构
- **channel_operators**: 操作用户信息
- **tasks**: 任务信息
- **task_message_details**: 消息发送明细
- **operator_credit_logs**: 积分消费记录

### 4.2 关键SQL操作
```sql
-- 创建任务
INSERT INTO tasks (tasks_title, tasks_message_content, operators_id, ...)

-- 创建消息明细
INSERT INTO task_message_details (tasks_id, recipient_number, ...)

-- 更新任务进度
UPDATE tasks SET tasks_success_count = ?, tasks_failed_count = ? WHERE tasks_id = ?

-- 扣除积分
UPDATE channel_operators SET operators_used_credits = operators_used_credits + ? WHERE operators_id = ?

-- 记录积分日志
INSERT INTO operator_credit_logs (operators_id, change_amount, change_type, ...)
```

## 🎨 5. UI组件规范

### 5.1 主窗口布局
```
┌─────────────────────────────────────────────────────────────────┐
│ 猫池短信系统          用户: operator001        余额: 积分10000    │
├─────────────────────────────────────────────────────────────────┤
│ 任务列表                    │              端口管理              │
│ ┌─────────────────────────┐ │ ┌─────────────────────────────────┐ │
│ │ [停止发送][添加任务][更多]│ │ │[全选][反选][选项][启动][停止]    │ │
│ │                         │ │ │                                 │ │
│ │ 任务1  50%  100  5  运行 │ │ │ COM1   移动   60   3   可用      │ │
│ │ 任务2  25%   50  2  暂停 │ │ │ COM2   联通   60   10  忙碌      │ │
│ │ ...                     │ │ │ ...                             │ │
│ └─────────────────────────┘ │ └─────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 对话框设计
- **创建任务对话框**: 表单布局，字段验证
- **测试任务对话框**: 简单表单，实时反馈
- **选项配置对话框**: 参数设置，数值验证

## 🔄 6. 状态流转图

### 6.1 任务状态
```
draft → pending → running → completed
  ↓       ↓         ↓         ↑
 删除    取消      暂停    ←──┘
                   ↓
                 恢复 → running
```

### 6.2 消息状态
```
pending → sending → success
    ↓       ↓         ↑
   取消    失败 → 重试
```

## 📝 7. 开发清单

### 7.1 核心模块
- [ ] 用户认证模块 (auth_service.py)
- [ ] 任务管理模块 (task_service.py)
- [ ] 端口管理模块 (port_service.py)
- [ ] 消息发送模块 (message_service.py)

### 7.2 界面模块
- [ ] 登录窗口 (login_window.py)
- [ ] 主窗口 (main_window.py)
- [ ] 任务对话框 (add_task_dialog.py, task_test_dialog.py)
- [ ] 配置对话框 (config_dialog.py)

### 7.3 核心功能
- [ ] 端口扫描器 (port_scanner.py)
- [ ] 任务执行器 (task_executor.py)
- [ ] 短信发送器 (message_sender.py)
- [ ] 文件处理器 (file_handler.py)